---
title: "MHWs vs. heat flux"
author: "Robert Schlegel"
date: "2020-02-25"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
csl: FMars.csl
bibliography: MHWflux.bib
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.align = 'center',
                      echo = TRUE, warning = FALSE, message = FALSE, 
                      eval = TRUE, tidy = FALSE)
```

## Introduction

This vignette will walk through the thinking and the process for how to link physical variables to their potential effect on driving or dissipating MHWs. The primary source that inspired this work was @Chen2016. In this paper the authors were able to illustrate which parts of the heat budget were mostly likely driving the anomalous heat content in the surface of the ocean. What this analysis seeks to do is to build on this methodology by applying the fundamental concept to ALL of the MHWs detected in the NW Atlantic. Fundamentally we are running thousands of correlations between SST anomalies and the co-occurrent anomalies for a range of physical variables. The stronger the correlation (both positive and negative) the more of an indication this is to us that these phenomena are related.

```{r startup}
# All of the libraries and objects used in the project
# Note that this also loads the data we will be using in this vignette
source("code/functions.R")
```

## Correlations

We know when the MHWs occurred, and our physical data are prepped, so what we need to do is run correlations between SST from the start to peak and peak to end of each event and the full suite of variables. This will show us for each event which values correlated the best for the onset AND decline of the events. We'll also run correlations on the full time series.

```{r MHW-var-cor, eval=FALSE}
# Extract just the event info
GLORYS_MHW_event_index <- GLORYS_MHW_event %>% 
  select(event_no, region) %>% 
  ungroup() %>% 
  mutate(row_index = 1:n())

# Run all the stats
ALL_cor <- plyr::ddply(GLORYS_MHW_event_index, .parallel = T,
                       .variables = c("row_index"), .fun = cor_all) %>% 
  left_join(GLORYS_MHW_event_index, by = "row_index") %>% 
  select(region, event_no, ts, var, n, r, rmse) %>% 
  arrange(region, event_no)

# Save
saveRDS(ALL_cor, "data/ALL_cor.Rda")
```

Seeing as how we're just running correlations at the moment (I snuck RMSE into the above calcs as well) everything runs pretty quickly. With the method sorted for now we need to have a look at the results. What we have at the moment is a long dataframe containing the correlations of different variables with the temperature anomaly. It must be pointed out that these are for the same day, there is no time lag introduced, which may be important. Below we are going to visualise the range of correlations for each variable to see how much each distribution is skewed. This skewness could probably be quantified in a meaningful way... but let's look at the data first.

```{r cor-visuals}
# Load data
ALL_cor <- readRDS("data/ALL_cor.Rda")

# Histogram grid of variable by time series part
ggplot(filter(ALL_cor, var != "temp"), aes(x = r)) +
  geom_histogram(bins = 10) +
  facet_grid(ts ~ var)

# Stacked histogram
ggplot(filter(ALL_cor, var != "temp"), aes(x = r)) +
  geom_histogram(aes(fill = region), bins = 10) +
  facet_grid(ts ~ var)

# Dodged histogram
ggplot(filter(ALL_cor, var != "temp"), aes(x = r)) +
  geom_histogram(aes(fill = region), bins = 5, position = "dodge") +
  facet_grid(ts ~ var)
```

We also want to filter by p-value to highlight the strong correlations.

Wow! What a surprise. There are some really clear patterns coming through in the data. In particular SSS seems to be strongly related to the onset of MHWs. There are a lot of nuances in these data and so I think this is actually an example of where a Shiny app is useful to interrogate the data.

```{r shiny-histo}
# source("shiny/app.R")
```

Below is a chunk of code I've just thrown up to look at specific events with the naked eye. I still need to create a convenience function that can pull out a chosen event and plot the variables as a scatterplot and time series so it is easy to see what exactly the direction of the correlations means.

```{r ts-explore, eval=FALSE}
# gm 32
# Get the info for the focus event
event_sub <- GLORYS_MHW_event %>% 
  filter(event_no == 15,
         region == "gm")
  
# Subset the time series for the onset and decline portions
ts_temp <- ALL_anom %>% 
  filter(t >= event_sub$date_start,
         t <= event_sub$date_end,
         region == event_sub$region, 
         var == "temp") %>% 
    dplyr::rename(temp_anom = anom) %>% 
    select(region, t, temp_anom)
ts_full <- ALL_anom %>% 
  filter(t >= event_sub$date_start,
         t <= event_sub$date_end,
         region == event_sub$region) %>% 
  left_join(ts_temp, by = c("region", "t"))# %>% 
  # filter(var == "temp")

# Time series plot
ggplot(data = filter(ts_full, var %in% c("msshf", "temp")), aes(x = t, y = anom)) +
  geom_line(aes(colour = var))

# Wide test data
ts_wide <- ts_full %>% 
  dplyr::select(-val, -seas, -thresh, -temp_anom) %>% 
  pivot_wider(names_from = var, values_from = anom) %>% 
  filter(t >= event_sub$date_peak)

# Scatterplot
plotly::ggplotly(ggplot(data = ts_wide, aes(x = msshf, y = temp)) +
                   geom_smooth(method = "lm") +
                   geom_point(aes(colour = t)))
```

## Notes

### NWA 2012

From Chen et al. 2016 (JGR)
Such an extreme event in the MAB was attributed to the anomalous atmospheric forcing, which was linked to the northward shift in the jet stream position [Chen et al., 2014a, 2015]. The anomalously warm atmospheric conditions in the winter of 2011–2012 increased the ocean heat content (increased the ocean heat content anomaly) and facilitated the extreme warm ocean temperature in spring 2012 [Chen et al., 2014a, 2015]. On the other hand, the ocean advection played a secondary role, which partially damped the heat content anomaly created by the air-sea heat flux [Chen et al., 2015].
In both cases, initial temperature and ocean advection are not sufficient to describe the seasonal mean temperature. Additional cooling (warming) in addition to ocean advection is needed to further describe the winter (spring) temperature. In comparison, using the sum of the initial temperature and air-sea flux yields a much better description of seasonal mean temperatures (Figures 5c and 5f)
While the overall role of ocean advection is smaller than that of air-sea flux in determining the winter and spring temperatures, the year-to-year changes in the relative importance is worth investigating.
Normally, given anomalous initial temperature, air will act to damp the temperature anomaly, as in winter 2007 or 2011, or even 2005 to some extent. However, in winter 2012, the air continued to increase the temperature anomaly.
Out of the 12 years 2003–2014, the air-sea flux normally dominated the temperature anomaly in the MAB during winter. In only 3 years was the winter time temperature anomaly primarily controlled by ocean advection.
For spring, ocean advection has more control on the temperature anomalies than air-sea flux does, although the difference is smaller (Table 2). In both seasons, the relative importance of air-sea flux and ocean advection does not seem to be related to either the initial or seasonal mean thermal condition of the shelf water (fourth and fifth columns of Tables 1 and 2).
The correlation coefficients increase from 0.66 in the first half of February to 0.91 in the second half of March. This suggests that estimation of spring temperature anomaly in the MAB  based  on  the  thermal  condition  2 months before spring is statistically possible.
This suggests that more northly jet stream positions result in larger heatflux from the atmosphere into the ocean in the MAB. This is likely due to warmer and more humid air overlying the continental shelf, which reduces the heat loss from the ocean during the cooling seasons [Chenet al., 2014a].
In spring and summer, the air-sea flux may be less correlated with the air temperature due to the shallowness of the surface mixed layer, and thus may be disconnected from large-scale atmospheric circulation, i.e., jetstream variability.

## References

